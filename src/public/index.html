<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>Note Synchronizer</title>
  </head>
  <style>
    * {
      box-sizing: border-box;
    }
    textarea {
      height: 300px;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 5px;
      margin-bottom: 5px;
    }

    input,
    textarea,
    pre {
      border: 1px solid #ccc;
      display: block;
      margin-bottom: 5px;
    }
    body {
      display: flex;
    }
    #form-parse-body,
    #form-sync-to-drive {
      flex-grow: 1;
      border: 1px solid black;
      padding: 10px;
    }
  </style>
  <body>
    <form id="form-parse-body" onsubmit="parseBody(event); return false">
      <select id="input-type-to-parse" value="messageId">
        <option value="messageId">messageId</option>
        <option value="threadId">threadId</option>
      </select>
      <input
        id="input-id-to-parse"
        placeholder="Message ID"
        value="10f4697640f6e6d6"
      />
      <div>
        <a id="output-url" target='_blank'></a>
      </div>
      <textarea id="output-raw-html" placeholder="Raw HTML"></textarea>
      <textarea id="output-parsed-html" placeholder="Parsed HTML"></textarea>
    </form>
    <form id="form-sync-to-drive" onsubmit="syncToDrive(event); return false">
      <select id="input-type-to-sync" value="messageId">
        <option value="messageId">messageId</option>
        <option value="threadId">threadId</option>
      </select>
      <input
        id="input-id-to-sync"
        placeholder="Message ID"
        value="10f4697640f6e6d6"
      />
    </form>
  </body>
  <script>
    function _wrapWork(func) {
      let loading = false;

      return async function (e) {
        if (loading) {
          return;
        }
        loading = true;
        await func(e.target);
        loading = false;
      };
    }

    const parseBody = _wrapWork(async function parseBody(targetEl) {
      const inputId = targetEl.querySelector("#input-id-to-parse").value;
      const inputType = targetEl.querySelector("#input-type-to-parse").value;

      targetEl.querySelector("#output-raw-html").value = '';
      targetEl.querySelector("#output-parsed-html").value = '';
      targetEl.querySelector("#output-url").innerText = '';

      if (inputId.length >= 16 && inputId.length < 20) {
        try {
          const result = await fetch(
            `/api/message/parse/${inputType}/${inputId}`
          ).then((res) => res.json());
          if (result.error) {
            return alert(result.error);
          }
          targetEl.querySelector("#output-raw-html").value = result.raw;
          targetEl.querySelector("#output-parsed-html").value =
            result.parsed_text;
          targetEl.querySelector("#output-url").href = `http://${result.url_to_crawl}`;
          targetEl.querySelector("#output-url").innerText = result.crawled_content.subject;
        } catch (err) {}
      }
    });

    const syncToDrive = _wrapWork(async function syncToDrive(targetEl) {
      const inputId = targetEl.querySelector("#input-id-to-sync").value;
      const inputType = targetEl.querySelector("#input-type-to-sync").value;
      if (inputId.length >= 16 && inputId.length < 20) {
        try {
          const result = await fetch(
            `/api/message/sync/${inputType}/${inputId}`
          ).then((res) => res.json());
          alert(JSON.stringify(result, null, 2));
        } catch (err) {}
      }
    });
  </script>
</html>
